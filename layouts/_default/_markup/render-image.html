{{- $src   := .Destination -}}
{{- $alt   := .Text -}}
{{- $title := .Title -}}
{{- $page  := .Page -}}

{{- $isExt := or (hasPrefix $src "http://") (hasPrefix $src "https://") -}}

<figure class="img-figure">
  {{- if $isExt }}
  <img
    src="{{ $src }}"
    alt="{{ $alt }}"
    loading="lazy"
    decoding="async"
  >
  {{- else }}
    {{- $res := $page.Resources.GetMatch $src -}}
    {{- if $res }}
  <img
    src="{{ $res.RelPermalink }}"
    alt="{{ $alt }}"
    width="{{ $res.Width }}"
    height="{{ $res.Height }}"
    loading="lazy"
    decoding="async"
  >
    {{- else }}
  <img
    src="{{ $src }}"
    alt="{{ $alt }}"
    loading="lazy"
    decoding="async"
  >
    {{- end }}
  {{- end }}
  {{- with $title }}
  <figcaption>{{ . }}</figcaption>
  {{- end }}
</figure>